#!/bin/bash
#
# qsys - Quantonium System Diagnostics
# Quick system health check and diagnostics tool
#
# Usage: qsys [command]
#   Commands:
#     info      System information (default)
#     health    System health check
#     net       Network diagnostics
#     disk      Disk usage and health
#     proc      Process information
#     dev       Development environment status
#     bench     Quick performance benchmark
#     all       Run all diagnostics

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# Icons
CHECK="${GREEN}✓${NC}"
CROSS="${RED}✗${NC}"
WARN="${YELLOW}!${NC}"
INFO="${CYAN}ℹ${NC}"

header() {
    echo -e "\n${PURPLE}━━━ $1 ━━━${NC}\n"
}

ok() { echo -e "  ${CHECK} $1"; }
fail() { echo -e "  ${CROSS} $1"; }
warn() { echo -e "  ${WARN} $1"; }
info() { echo -e "  ${INFO} $1"; }

bytes_to_human() {
    numfmt --to=iec-i --suffix=B "$1" 2>/dev/null || echo "$1"
}

# =============================================================================
# System Information
# =============================================================================

cmd_info() {
    header "System Information"

    # OS Info
    if [[ -f /etc/os-release ]]; then
        source /etc/os-release
        info "OS: ${PRETTY_NAME:-$NAME $VERSION}"
    fi

    # Kernel
    info "Kernel: $(uname -r)"
    info "Architecture: $(uname -m)"

    # Uptime
    info "Uptime: $(uptime -p | sed 's/up //')"

    # CPU
    local cpu_model
    cpu_model=$(grep -m1 'model name' /proc/cpuinfo | cut -d: -f2 | xargs)
    local cpu_cores
    cpu_cores=$(nproc)
    info "CPU: ${cpu_model} (${cpu_cores} cores)"

    # Memory
    local mem_total mem_avail
    mem_total=$(grep MemTotal /proc/meminfo | awk '{print $2 * 1024}')
    mem_avail=$(grep MemAvailable /proc/meminfo | awk '{print $2 * 1024}')
    info "Memory: $(bytes_to_human "$mem_avail") available / $(bytes_to_human "$mem_total") total"

    # Swap
    local swap_total swap_free
    swap_total=$(grep SwapTotal /proc/meminfo | awk '{print $2 * 1024}')
    swap_free=$(grep SwapFree /proc/meminfo | awk '{print $2 * 1024}')
    if [[ "$swap_total" -gt 0 ]]; then
        info "Swap: $(bytes_to_human "$swap_free") free / $(bytes_to_human "$swap_total") total"
    else
        info "Swap: None configured"
    fi

    # GPU
    if command -v lspci &>/dev/null; then
        local gpu
        gpu=$(lspci | grep -i 'vga\|3d\|2d' | head -1 | cut -d: -f3 | xargs)
        [[ -n "$gpu" ]] && info "GPU: $gpu"
    fi

    # Shell
    info "Shell: $SHELL"

    # Desktop
    [[ -n "$XDG_CURRENT_DESKTOP" ]] && info "Desktop: $XDG_CURRENT_DESKTOP"
}

# =============================================================================
# Health Check
# =============================================================================

cmd_health() {
    header "System Health"

    # Load average
    local load
    load=$(cut -d' ' -f1 /proc/loadavg)
    local cores
    cores=$(nproc)
    if (( $(echo "$load < $cores" | bc -l) )); then
        ok "Load average: $load (${cores} cores)"
    else
        warn "Load average: $load (${cores} cores) - HIGH"
    fi

    # Memory usage
    local mem_total mem_avail mem_pct
    mem_total=$(grep MemTotal /proc/meminfo | awk '{print $2}')
    mem_avail=$(grep MemAvailable /proc/meminfo | awk '{print $2}')
    mem_pct=$((100 - (mem_avail * 100 / mem_total)))
    if [[ $mem_pct -lt 80 ]]; then
        ok "Memory usage: ${mem_pct}%"
    elif [[ $mem_pct -lt 90 ]]; then
        warn "Memory usage: ${mem_pct}%"
    else
        fail "Memory usage: ${mem_pct}% - CRITICAL"
    fi

    # Disk usage (root)
    local disk_pct
    disk_pct=$(df / | tail -1 | awk '{print $5}' | tr -d '%')
    if [[ $disk_pct -lt 80 ]]; then
        ok "Disk usage (/): ${disk_pct}%"
    elif [[ $disk_pct -lt 90 ]]; then
        warn "Disk usage (/): ${disk_pct}%"
    else
        fail "Disk usage (/): ${disk_pct}% - CRITICAL"
    fi

    # Zombie processes
    local zombies
    zombies=$(ps aux | awk '$8=="Z"' | wc -l)
    if [[ $zombies -eq 0 ]]; then
        ok "Zombie processes: 0"
    else
        warn "Zombie processes: $zombies"
    fi

    # Failed systemd units
    if command -v systemctl &>/dev/null; then
        local failed
        failed=$(systemctl --failed --no-legend 2>/dev/null | wc -l)
        if [[ $failed -eq 0 ]]; then
            ok "Failed systemd units: 0"
        else
            warn "Failed systemd units: $failed"
        fi
    fi

    # Security updates (if apt available)
    if command -v apt &>/dev/null; then
        local security
        security=$(apt list --upgradable 2>/dev/null | grep -i security | wc -l)
        if [[ $security -eq 0 ]]; then
            ok "Security updates: none pending"
        else
            warn "Security updates: $security available"
        fi
    fi
}

# =============================================================================
# Network Diagnostics
# =============================================================================

cmd_net() {
    header "Network Status"

    # Interfaces
    info "Interfaces:"
    ip -br addr | while read -r iface state addrs; do
        if [[ "$state" == "UP" ]]; then
            echo -e "    ${GREEN}${iface}${NC}: ${addrs}"
        else
            echo -e "    ${GRAY}${iface}${NC}: ${state}"
        fi
    done

    # Default gateway
    local gw
    gw=$(ip route | grep default | head -1 | awk '{print $3}')
    [[ -n "$gw" ]] && info "Gateway: $gw"

    # DNS
    local dns
    dns=$(grep nameserver /etc/resolv.conf | head -1 | awk '{print $2}')
    [[ -n "$dns" ]] && info "DNS: $dns"

    # Internet connectivity
    echo ""
    if ping -c1 -W2 8.8.8.8 &>/dev/null; then
        ok "Internet: reachable (ping)"
    else
        fail "Internet: unreachable"
    fi

    # DNS resolution
    if host google.com &>/dev/null; then
        ok "DNS resolution: working"
    else
        fail "DNS resolution: failing"
    fi

    # Listening ports
    header "Listening Ports"
    ss -tuln | grep LISTEN | awk '{print $5}' | sort -u | head -10 | while read -r port; do
        echo "    $port"
    done
}

# =============================================================================
# Disk Information
# =============================================================================

cmd_disk() {
    header "Disk Usage"

    df -h --output=source,fstype,size,used,avail,pcent,target | \
        grep -v "tmpfs\|devtmpfs\|loop" | \
        head -20

    header "Largest Directories (/home)"
    if [[ -d "$HOME" ]]; then
        du -h --max-depth=1 "$HOME" 2>/dev/null | sort -hr | head -10
    fi

    # SMART status (if available)
    if command -v smartctl &>/dev/null; then
        header "Disk Health (SMART)"
        for disk in /dev/sd? /dev/nvme?n1; do
            [[ -b "$disk" ]] || continue
            local health
            health=$(sudo smartctl -H "$disk" 2>/dev/null | grep -i "health\|result" | head -1)
            if [[ -n "$health" ]]; then
                if echo "$health" | grep -qi "passed\|ok"; then
                    ok "$disk: PASSED"
                else
                    fail "$disk: $health"
                fi
            fi
        done 2>/dev/null || info "Run with sudo for SMART data"
    fi
}

# =============================================================================
# Process Information
# =============================================================================

cmd_proc() {
    header "Top Processes (CPU)"
    ps aux --sort=-%cpu | head -6 | tail -5 | \
        awk '{printf "  %-8s %5.1f%% CPU  %5.1f%% MEM  %s\n", $1, $3, $4, $11}'

    header "Top Processes (Memory)"
    ps aux --sort=-%mem | head -6 | tail -5 | \
        awk '{printf "  %-8s %5.1f%% MEM  %s\n", $1, $4, $11}'

    header "Process Summary"
    info "Total processes: $(ps aux | wc -l)"
    info "Running: $(ps aux | awk '$8=="R"' | wc -l)"
    info "Sleeping: $(ps aux | awk '$8~/S/' | wc -l)"

    # Docker containers
    if command -v docker &>/dev/null && docker ps &>/dev/null; then
        local running
        running=$(docker ps -q | wc -l)
        if [[ $running -gt 0 ]]; then
            header "Docker Containers"
            docker ps --format "  {{.Names}}: {{.Status}}"
        fi
    fi
}

# =============================================================================
# Development Environment Status
# =============================================================================

cmd_dev() {
    header "Development Environment"

    # Languages
    echo -e "  ${CYAN}Languages:${NC}"
    command -v python3 &>/dev/null && echo "    Python: $(python3 --version 2>&1 | awk '{print $2}')"
    command -v node &>/dev/null && echo "    Node.js: $(node --version)"
    command -v go &>/dev/null && echo "    Go: $(go version | awk '{print $3}')"
    command -v rustc &>/dev/null && echo "    Rust: $(rustc --version | awk '{print $2}')"
    command -v gcc &>/dev/null && echo "    GCC: $(gcc --version | head -1 | awk '{print $NF}')"
    command -v clang &>/dev/null && echo "    Clang: $(clang --version | head -1 | awk '{print $4}')"

    # Tools
    echo ""
    echo -e "  ${CYAN}Tools:${NC}"
    command -v git &>/dev/null && echo "    Git: $(git --version | awk '{print $3}')"
    command -v docker &>/dev/null && echo "    Docker: $(docker --version | awk '{print $3}' | tr -d ',')"
    command -v kubectl &>/dev/null && echo "    kubectl: $(kubectl version --client -o json 2>/dev/null | jq -r '.clientVersion.gitVersion' 2>/dev/null || echo 'installed')"

    # Package managers
    echo ""
    echo -e "  ${CYAN}Package Managers:${NC}"
    command -v pip3 &>/dev/null && echo "    pip: $(pip3 --version | awk '{print $2}')"
    command -v npm &>/dev/null && echo "    npm: $(npm --version)"
    command -v cargo &>/dev/null && echo "    cargo: $(cargo --version | awk '{print $2}')"

    # Git configuration
    echo ""
    if git config --global user.name &>/dev/null; then
        ok "Git user configured: $(git config --global user.name)"
    else
        warn "Git user not configured (run: git config --global user.name 'Your Name')"
    fi

    if git config --global user.email &>/dev/null; then
        ok "Git email configured"
    else
        warn "Git email not configured (run: git config --global user.email 'you@example.com')"
    fi

    # SSH key
    if [[ -f "$HOME/.ssh/id_ed25519" ]] || [[ -f "$HOME/.ssh/id_rsa" ]]; then
        ok "SSH key exists"
    else
        warn "No SSH key found (run: ssh-keygen -t ed25519)"
    fi
}

# =============================================================================
# Quick Benchmark
# =============================================================================

cmd_bench() {
    header "Quick Benchmark"

    # CPU (single-core)
    echo -e "  ${CYAN}CPU (single-core):${NC}"
    local start end duration ops_per_sec
    start=$(date +%s.%N)
    for ((i=0; i<1000000; i++)); do :; done
    end=$(date +%s.%N)
    duration=$(echo "$end - $start" | bc)
    ops_per_sec=$(echo "1000000 / $duration" | bc)
    echo "    Bash loop: ${ops_per_sec} ops/sec"

    # Disk (sequential write)
    echo -e "\n  ${CYAN}Disk (sequential write):${NC}"
    local tmpfile="/tmp/qsys_bench_$$"
    sync
    dd if=/dev/zero of="$tmpfile" bs=1M count=256 conv=fdatasync 2>&1 | grep -E '[0-9.]+ [MG]B/s' | awk '{print "    Write: " $(NF-1) " " $NF}'
    rm -f "$tmpfile"

    # Memory bandwidth (rough estimate)
    echo -e "\n  ${CYAN}Memory:${NC}"
    dd if=/dev/zero of=/dev/null bs=1M count=1024 2>&1 | grep -E '[0-9.]+ [MG]B/s' | awk '{print "    Bandwidth: " $(NF-1) " " $NF}'
}

# =============================================================================
# Main
# =============================================================================

case "${1:-info}" in
    info)   cmd_info ;;
    health) cmd_health ;;
    net)    cmd_net ;;
    disk)   cmd_disk ;;
    proc)   cmd_proc ;;
    dev)    cmd_dev ;;
    bench)  cmd_bench ;;
    all)
        cmd_info
        cmd_health
        cmd_dev
        cmd_net
        cmd_disk
        cmd_proc
        ;;
    -h|--help|help)
        echo "Usage: qsys [command]"
        echo ""
        echo "Commands:"
        echo "  info      System information (default)"
        echo "  health    System health check"
        echo "  net       Network diagnostics"
        echo "  disk      Disk usage and health"
        echo "  proc      Process information"
        echo "  dev       Development environment status"
        echo "  bench     Quick performance benchmark"
        echo "  all       Run all diagnostics"
        ;;
    *)
        echo "Unknown command: $1"
        echo "Run 'qsys --help' for usage"
        exit 1
        ;;
esac
