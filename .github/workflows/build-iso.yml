name: Build ISO

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            debootstrap \
            squashfs-tools \
            xorriso \
            grub-pc-bin \
            grub-efi-amd64-bin \
            grub-efi-amd64-signed \
            shim-signed \
            mtools \
            dosfstools \
            isolinux \
            syslinux-utils \
            rsync \
            wget \
            curl

      - name: Build ISO
        run: |
          set -x
          sudo chmod +x build-system/build.sh
          # Convert to Unix line endings if needed
          sudo sed -i 's/\r$//' build-system/build.sh
          sudo sed -i 's/\r$//' build-system/packages/desktop.list
          sudo sed -i 's/\r$//' tools/bin/qsys
          sudo sed -i 's/\r$//' tools/bin/qdev
          # Check script is valid
          bash -n build-system/build.sh
          # Run with verbose output
          sudo bash -x build-system/build.sh 2>&1 || {
            echo "Build failed, showing last 100 lines of any logs..."
            find build-system/build -name "*.log" -exec tail -100 {} \; 2>/dev/null || true
          }

      - name: List output
        run: |
          echo "Build output:"
          ls -la build-system/output/

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: quantonium-iso
          path: build-system/output/*
          retention-days: 7

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: build-system/output/*
          fail_on_unmatched_files: true
          body: |
            ## Quantonium ${{ github.ref_name }}

            A developer-focused Linux distribution based on Ubuntu 24.04 LTS.

            ### What's Included
            - Modern CLI tools: ripgrep, fd, fzf, bat, zoxide, delta, jq
            - Containers: Docker, Podman, kubectl
            - Languages: Python, Node.js, Go, Rust, C/C++
            - System tuning for developer workloads

            ### Installation
            1. Download the ISO
            2. Write to USB: `sudo dd if=quantonium-*.iso of=/dev/sdX bs=4M status=progress conv=fsync`
            3. Boot from USB
            4. Follow installer

            ### Checksums
            See SHA256SUMS and MD5SUMS files.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
